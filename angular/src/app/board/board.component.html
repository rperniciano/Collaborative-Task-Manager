<div class="board-container">
  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading your board...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="alert alert-danger m-4" role="alert">
      {{ error() }}
      <button class="btn btn-link" (click)="ngOnInit()">Try Again</button>
    </div>
  }

  <!-- Board View -->
  @if (board() && !loading()) {
    <div class="board-header">
      <h1 class="board-title">{{ board()!.name }}</h1>
      <div class="board-info">
        <span class="text-muted">Welcome, {{ currentUserName }}</span>
        @if (board()!.isOwner) {
          <button class="btn btn-outline-secondary btn-sm ms-3" (click)="openSettingsModal()">
            <i class="fa fa-cog me-1"></i> Settings
          </button>
        }
      </div>
      <!-- Online Members Section -->
      <div class="online-members-section">
        <div class="online-members-label">
          <i class="fa fa-circle text-success me-1" style="font-size: 0.5rem;"></i>
          Online Members
        </div>
        <div class="online-members-list">
          @if (onlineUsers().length === 0) {
            <span class="text-muted small">No other members online</span>
          } @else {
            @for (user of onlineUsers(); track user.userId) {
              <span class="online-member-badge" title="{{ user.userName }}">
                <i class="fa fa-user-circle me-1"></i>{{ user.userName }}
              </span>
            }
          }
        </div>
      </div>
    </div>

    <div class="columns-container" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="onColumnDrop($event)">
      @for (column of columnsWithTasks(); track column.id) {
        <div class="column" cdkDrag>
          <div class="column-header" cdkDragHandle>
            <h2 class="column-title">{{ column.name }}</h2>
            <span class="task-count">{{ getTaskCount(column) }} {{ getTaskCount(column) === 1 ? 'task' : 'tasks' }}</span>
          </div>
          <div class="column-content">
            <!-- Tasks List -->
            @if (column.tasks && column.tasks.length > 0) {
              @for (task of column.tasks; track task.id) {
                <div class="task-card" (click)="openTaskModal(task)">
                  <div class="task-title">{{ task.title }}</div>
                  @if (task.description) {
                    <div class="task-description">{{ task.description }}</div>
                  }
                  <div class="task-meta">
                    <span class="priority-badge" [class]="getPriorityClass(task.priority)">
                      {{ getPriorityLabel(task.priority) }}
                    </span>
                    @if (task.dueDate) {
                      <span class="due-date">
                        <i class="fa fa-calendar me-1"></i>
                        {{ task.dueDate | date:'shortDate' }}
                      </span>
                    }
                    @if (task.assigneeName) {
                      <span class="assignee">
                        <i class="fa fa-user me-1"></i>
                        {{ task.assigneeName }}
                      </span>
                    }
                  </div>
                </div>
              }
            } @else {
              <!-- Empty Column Placeholder -->
              @if (showAddTaskForm() !== column.id) {
                <div class="empty-column-placeholder">
                  <p class="text-muted">Drop a task here</p>
                </div>
              }
            }

            <!-- Add Task Form (inline) -->
            @if (showAddTaskForm() === column.id) {
              <div class="add-task-form">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Enter task title..."
                  [(ngModel)]="newTaskTitle"
                  (keyup.enter)="createTask(column.id)"
                  (keyup.escape)="cancelAddTask()"
                  [disabled]="creatingTask()"
                  autofocus
                />
                <div class="add-task-actions">
                  <button
                    class="btn btn-primary btn-sm"
                    (click)="createTask(column.id)"
                    [disabled]="creatingTask() || !newTaskTitle().trim()"
                  >
                    @if (creatingTask()) {
                      <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    Add
                  </button>
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    (click)="cancelAddTask()"
                    [disabled]="creatingTask()"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            }
          </div>
          <div class="column-footer">
            @if (showAddTaskForm() !== column.id) {
              <button
                class="btn btn-outline-primary btn-sm add-task-btn"
                (click)="openAddTaskForm(column.id)"
              >
                <i class="fa fa-plus me-1"></i> Add task
              </button>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Task Detail Modal -->
  @if (showTaskModal() && selectedTask()) {
    <div class="modal-backdrop" (click)="onModalBackdropClick($event)">
      <div class="task-modal">
        <div class="modal-header">
          <h3 class="modal-title">Task Details</h3>
          <button class="close-btn" (click)="closeTaskModal()" aria-label="Close modal">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Task Title -->
          <div class="field-group">
            <label class="field-label">Title</label>
            <div class="field-value task-title-display">{{ selectedTask()!.title }}</div>
          </div>

          <!-- Task Status/Column -->
          <div class="field-group">
            <label class="field-label">Status</label>
            <div class="field-value">
              <span class="status-badge">{{ getColumnNameForTask(selectedTask()!) }}</span>
            </div>
          </div>

          <!-- Task Priority -->
          <div class="field-group">
            <label class="field-label">Priority</label>
            <div class="field-value">
              <span class="priority-badge" [class]="getPriorityClass(selectedTask()!.priority)">
                {{ getPriorityLabel(selectedTask()!.priority) }}
              </span>
            </div>
          </div>

          <!-- Task Description -->
          <div class="field-group">
            <label class="field-label">Description</label>
            <div class="field-value description-value">
              @if (selectedTask()!.description) {
                {{ selectedTask()!.description }}
              } @else {
                <span class="no-value">No description</span>
              }
            </div>
          </div>

          <!-- Task Due Date -->
          <div class="field-group">
            <label class="field-label">Due Date</label>
            <div class="field-value">
              @if (selectedTask()!.dueDate) {
                <span class="due-date-value">
                  <i class="fa fa-calendar me-2"></i>
                  {{ selectedTask()!.dueDate | date:'fullDate' }}
                </span>
              } @else {
                <span class="no-value">No due date set</span>
              }
            </div>
          </div>

          <!-- Task Assignee -->
          <div class="field-group">
            <label class="field-label">Assignee</label>
            <div class="field-value">
              @if (selectedTask()!.assigneeName) {
                <span class="assignee-value">
                  <i class="fa fa-user me-2"></i>
                  {{ selectedTask()!.assigneeName }}
                </span>
              } @else {
                <span class="no-value">Unassigned</span>
              }
            </div>
          </div>

          <!-- Checklist Section -->
          <div class="field-group checklist-section">
            <label class="field-label">
              <i class="fa fa-check-square me-2"></i>Checklist
              @if (getTotalChecklistCount(selectedTask()!) > 0) {
                <span class="checklist-progress">
                  ({{ getCompletedChecklistCount(selectedTask()!) }}/{{ getTotalChecklistCount(selectedTask()!) }})
                </span>
              }
            </label>

            <!-- Checklist Items -->
            <div class="checklist-items">
              @if (selectedTask()!.checklistItems && selectedTask()!.checklistItems.length > 0) {
                @for (item of selectedTask()!.checklistItems; track item.id) {
                  <div class="checklist-item" [class.completed]="item.isCompleted">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      [checked]="item.isCompleted"
                      (change)="toggleChecklistItem(item)"
                    />
                    <span class="checklist-item-text" [class.text-decoration-line-through]="item.isCompleted">
                      {{ item.text }}
                    </span>
                    <button
                      class="btn btn-sm btn-outline-danger checklist-delete-btn"
                      (click)="deleteChecklistItem(item)"
                      title="Delete item"
                    >
                      <i class="fa fa-times"></i>
                    </button>
                  </div>
                }
              } @else {
                <p class="no-value mb-2">No checklist items yet</p>
              }
            </div>

            <!-- Add Checklist Item Form -->
            <div class="add-checklist-form">
              <div class="input-group input-group-sm">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Add a checklist item..."
                  [(ngModel)]="newChecklistItemText"
                  (keyup.enter)="addChecklistItem()"
                  [disabled]="addingChecklistItem()"
                />
                <button
                  class="btn btn-primary"
                  (click)="addChecklistItem()"
                  [disabled]="addingChecklistItem() || !newChecklistItemText().trim()"
                >
                  @if (addingChecklistItem()) {
                    <span class="spinner-border spinner-border-sm"></span>
                  } @else {
                    <i class="fa fa-plus"></i>
                  }
                </button>
              </div>
            </div>
          </div>

          <!-- Task Timestamps -->
          <div class="field-group">
            <label class="field-label">Created</label>
            <div class="field-value timestamp-value">
              {{ selectedTask()!.creationTime | date:'medium' }}
            </div>
          </div>

          @if (selectedTask()!.lastModificationTime) {
            <div class="field-group">
              <label class="field-label">Last Modified</label>
              <div class="field-value timestamp-value">
                {{ selectedTask()!.lastModificationTime | date:'medium' }}
              </div>
            </div>
          }
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-danger me-auto"
            (click)="deleteTask()"
            [disabled]="deletingTask()"
          >
            @if (deletingTask()) {
              <span class="spinner-border spinner-border-sm me-1"></span>
            }
            <i class="fa fa-trash me-1"></i> Delete
          </button>
          <button class="btn btn-secondary" (click)="closeTaskModal()" [disabled]="deletingTask()">Close</button>
        </div>
      </div>
    </div>
  }

  <!-- Board Settings Modal (Owner Only) -->
  @if (showSettingsModal()) {
    <div class="modal-backdrop" (click)="onSettingsBackdropClick($event)">
      <div class="settings-modal">
        <div class="modal-header">
          <h3 class="modal-title">Board Settings</h3>
          <button class="close-btn" (click)="closeSettingsModal()" aria-label="Close modal">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Board Name Section (Owner Only) -->
          <div class="settings-section">
            <h4 class="section-title">
              <i class="fa fa-edit me-2"></i>Board Name
            </h4>
            <div class="rename-form">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Enter board name..."
                  [(ngModel)]="editBoardName"
                  [disabled]="renamingBoard()"
                  (keyup.enter)="renameBoard()"
                />
                <button
                  class="btn btn-primary"
                  (click)="renameBoard()"
                  [disabled]="renamingBoard() || !editBoardName().trim()"
                >
                  @if (renamingBoard()) {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                  }
                  <i class="fa fa-save me-1"></i> Save
                </button>
              </div>
              @if (renameError()) {
                <div class="alert alert-danger mt-2 mb-0">{{ renameError() }}</div>
              }
              @if (renameSuccess()) {
                <div class="alert alert-success mt-2 mb-0">{{ renameSuccess() }}</div>
              }
            </div>
          </div>

          <!-- Invite Member Section -->
          <div class="settings-section">
            <h4 class="section-title">
              <i class="fa fa-user-plus me-2"></i>Invite Member
            </h4>
            <div class="invite-form">
              <div class="input-group">
                <input
                  type="email"
                  class="form-control"
                  placeholder="Enter email address..."
                  [(ngModel)]="inviteEmail"
                  [disabled]="sendingInvite()"
                  (keyup.enter)="sendInvite()"
                />
                <button
                  class="btn btn-primary"
                  (click)="sendInvite()"
                  [disabled]="sendingInvite() || !inviteEmail().trim()"
                >
                  @if (sendingInvite()) {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                  }
                  <i class="fa fa-paper-plane me-1"></i> Send Invite
                </button>
              </div>
              @if (inviteError()) {
                <div class="alert alert-danger mt-2 mb-0">{{ inviteError() }}</div>
              }
              @if (inviteSuccess()) {
                <div class="alert alert-success mt-2 mb-0">{{ inviteSuccess() }}</div>
              }
            </div>
          </div>

          <!-- Pending Invites Section -->
          <div class="settings-section">
            <h4 class="section-title">
              <i class="fa fa-envelope me-2"></i>Pending Invites
            </h4>
            @if (loadingInvites()) {
              <div class="text-center py-3">
                <span class="spinner-border spinner-border-sm"></span>
                Loading...
              </div>
            } @else if (pendingInvites().length === 0) {
              <p class="text-muted mb-0">No pending invitations.</p>
            } @else {
              <div class="invites-list">
                @for (invite of pendingInvites(); track invite.id) {
                  <div class="invite-item" [class.expired]="invite.isExpired">
                    <div class="invite-info">
                      <span class="invite-email">{{ invite.email }}</span>
                      <span class="invite-status" [class.text-danger]="invite.isExpired">
                        @if (invite.isExpired) {
                          Expired
                        } @else {
                          Expires {{ invite.expiresAt | date:'shortDate' }}
                        }
                      </span>
                    </div>
                    <button
                      class="btn btn-outline-danger btn-sm"
                      (click)="cancelInvite(invite.id)"
                      [disabled]="cancellingInvite() === invite.id"
                      title="Cancel invitation"
                    >
                      @if (cancellingInvite() === invite.id) {
                        <span class="spinner-border spinner-border-sm"></span>
                      } @else {
                        <i class="fa fa-times"></i>
                      }
                    </button>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Members Section -->
          <div class="settings-section">
            <h4 class="section-title">
              <i class="fa fa-users me-2"></i>Board Members
            </h4>
            @if (loadingMembers()) {
              <div class="text-center py-3">
                <span class="spinner-border spinner-border-sm"></span>
                Loading...
              </div>
            } @else if (members().length === 0) {
              <p class="text-muted mb-0">No members yet. Invite someone!</p>
            } @else {
              <div class="members-list">
                @for (member of members(); track member.userId) {
                  <div class="member-item">
                    <div class="member-info">
                      <span class="member-avatar">{{ getInitials(member.displayName) }}</span>
                      <div class="member-details">
                        <span class="member-name">
                          {{ member.displayName }}
                          @if (member.isOwner) {
                            <span class="badge bg-primary ms-1">Owner</span>
                          }
                        </span>
                        <span class="member-email">{{ member.email }}</span>
                      </div>
                    </div>
                    @if (!member.isOwner && board()!.isOwner) {
                      <button
                        class="btn btn-outline-danger btn-sm"
                        (click)="removeMember(member.userId)"
                        [disabled]="removingMember() === member.userId"
                        title="Remove member"
                      >
                        @if (removingMember() === member.userId) {
                          <span class="spinner-border spinner-border-sm"></span>
                        } @else {
                          <i class="fa fa-user-times"></i>
                        }
                      </button>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeSettingsModal()">Close</button>
        </div>
      </div>
    </div>
  }
</div>
