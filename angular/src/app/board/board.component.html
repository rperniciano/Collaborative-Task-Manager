<div class="board-container">
  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading your board...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="alert alert-danger m-4" role="alert">
      {{ error() }}
      <button class="btn btn-link" (click)="ngOnInit()">Try Again</button>
    </div>
  }

  <!-- Board View -->
  @if (board() && !loading()) {
    <div class="board-header">
      <h1 class="board-title">{{ board()!.name }}</h1>
      <div class="board-info">
        <span class="text-muted">Welcome, {{ currentUserName }}</span>
      </div>
    </div>

    <div class="columns-container">
      @for (column of columnsWithTasks(); track column.id) {
        <div class="column">
          <div class="column-header">
            <h2 class="column-title">{{ column.name }}</h2>
            <span class="task-count">{{ getTaskCount(column) }} {{ getTaskCount(column) === 1 ? 'task' : 'tasks' }}</span>
          </div>
          <div class="column-content">
            <!-- Tasks List -->
            @if (column.tasks && column.tasks.length > 0) {
              @for (task of column.tasks; track task.id) {
                <div class="task-card" (click)="openTaskModal(task)">
                  <div class="task-title">{{ task.title }}</div>
                  @if (task.description) {
                    <div class="task-description">{{ task.description }}</div>
                  }
                  <div class="task-meta">
                    <span class="priority-badge" [class]="getPriorityClass(task.priority)">
                      {{ getPriorityLabel(task.priority) }}
                    </span>
                    @if (task.dueDate) {
                      <span class="due-date">
                        <i class="fa fa-calendar me-1"></i>
                        {{ task.dueDate | date:'shortDate' }}
                      </span>
                    }
                    @if (task.assigneeName) {
                      <span class="assignee">
                        <i class="fa fa-user me-1"></i>
                        {{ task.assigneeName }}
                      </span>
                    }
                  </div>
                </div>
              }
            } @else {
              <!-- Empty Column Placeholder -->
              @if (showAddTaskForm() !== column.id) {
                <div class="empty-column-placeholder">
                  <p class="text-muted">Drop a task here</p>
                </div>
              }
            }

            <!-- Add Task Form (inline) -->
            @if (showAddTaskForm() === column.id) {
              <div class="add-task-form">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Enter task title..."
                  [(ngModel)]="newTaskTitle"
                  (keyup.enter)="createTask(column.id)"
                  (keyup.escape)="cancelAddTask()"
                  [disabled]="creatingTask()"
                  autofocus
                />
                <div class="add-task-actions">
                  <button
                    class="btn btn-primary btn-sm"
                    (click)="createTask(column.id)"
                    [disabled]="creatingTask() || !newTaskTitle().trim()"
                  >
                    @if (creatingTask()) {
                      <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    Add
                  </button>
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    (click)="cancelAddTask()"
                    [disabled]="creatingTask()"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            }
          </div>
          <div class="column-footer">
            @if (showAddTaskForm() !== column.id) {
              <button
                class="btn btn-outline-primary btn-sm add-task-btn"
                (click)="openAddTaskForm(column.id)"
              >
                <i class="fa fa-plus me-1"></i> Add task
              </button>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Task Detail Modal -->
  @if (showTaskModal() && selectedTask()) {
    <div class="modal-backdrop" (click)="onModalBackdropClick($event)">
      <div class="task-modal">
        <div class="modal-header">
          <h3 class="modal-title">Task Details</h3>
          <button class="close-btn" (click)="closeTaskModal()" aria-label="Close modal">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Task Title -->
          <div class="field-group">
            <label class="field-label">Title</label>
            <div class="field-value task-title-display">{{ selectedTask()!.title }}</div>
          </div>

          <!-- Task Status/Column -->
          <div class="field-group">
            <label class="field-label">Status</label>
            <div class="field-value">
              <span class="status-badge">{{ getColumnNameForTask(selectedTask()!) }}</span>
            </div>
          </div>

          <!-- Task Priority -->
          <div class="field-group">
            <label class="field-label">Priority</label>
            <div class="field-value">
              <span class="priority-badge" [class]="getPriorityClass(selectedTask()!.priority)">
                {{ getPriorityLabel(selectedTask()!.priority) }}
              </span>
            </div>
          </div>

          <!-- Task Description -->
          <div class="field-group">
            <label class="field-label">Description</label>
            <div class="field-value description-value">
              @if (selectedTask()!.description) {
                {{ selectedTask()!.description }}
              } @else {
                <span class="no-value">No description</span>
              }
            </div>
          </div>

          <!-- Task Due Date -->
          <div class="field-group">
            <label class="field-label">Due Date</label>
            <div class="field-value">
              @if (selectedTask()!.dueDate) {
                <span class="due-date-value">
                  <i class="fa fa-calendar me-2"></i>
                  {{ selectedTask()!.dueDate | date:'fullDate' }}
                </span>
              } @else {
                <span class="no-value">No due date set</span>
              }
            </div>
          </div>

          <!-- Task Assignee -->
          <div class="field-group">
            <label class="field-label">Assignee</label>
            <div class="field-value">
              @if (selectedTask()!.assigneeName) {
                <span class="assignee-value">
                  <i class="fa fa-user me-2"></i>
                  {{ selectedTask()!.assigneeName }}
                </span>
              } @else {
                <span class="no-value">Unassigned</span>
              }
            </div>
          </div>

          <!-- Task Timestamps -->
          <div class="field-group">
            <label class="field-label">Created</label>
            <div class="field-value timestamp-value">
              {{ selectedTask()!.creationTime | date:'medium' }}
            </div>
          </div>

          @if (selectedTask()!.lastModificationTime) {
            <div class="field-group">
              <label class="field-label">Last Modified</label>
              <div class="field-value timestamp-value">
                {{ selectedTask()!.lastModificationTime | date:'medium' }}
              </div>
            </div>
          }
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeTaskModal()">Close</button>
        </div>
      </div>
    </div>
  }
</div>
